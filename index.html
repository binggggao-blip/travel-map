<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>我的旅行足迹地图</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        #main {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        /* 控制面板 */
        .control-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .control-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .control-panel button {
            margin: 5px;
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .control-panel button:hover {
            background: #f0f0f0;
        }

        /* 详情弹窗 */
        .detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .modal-title {
            font-size: 20px;
            margin: 0 0 15px;
            color: #333;
        }
        .modal-image {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 8px;
            object-fit: contain;
        }
        .modal-actions {
            margin-top: 15px;
        }
        .modal-actions button {
            padding: 8px 16px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .add-btn {
            background: #52c41a;
            color: white;
        }
        .upload-btn {
            background: #fa8c16;
            color: white;
        }
        .close-btn {
            background: #f0f0f0;
            color: #333;
        }
        .add-btn:hover { background: #49a90d; }
        .upload-btn:hover { background: #d46b08; }
        .close-btn:hover { background: #e0e0e0; }

        @media (max-width: 600px) {
            .modal-content {
                padding: 15px;
            }
            .modal-title {
                font-size: 18px;
            }
            .modal-actions button {
                padding: 6px 12px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- 地图容器 -->
    <div id="main"></div>

    <!-- 控制面板 -->
    <div class="control-panel">
        <h3>我的旅行足迹地图</h3>
        <button id="resetBtn">重置所有数据</button>
        <button id="exportBtn">导出数据</button>
        <button id="importBtn">导入数据</button>
    </div>

    <!-- 详情弹窗 -->
    <div class="detail-modal" id="detailModal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalAreaName">区域名称</h3>
            <img 
                class="modal-image" 
                id="modalImage" 
                src="https://via.placeholder.com/600x400/e0e0e0/999999?text=点击“上传图片”自定义"
                alt="区域图片"
            />
            <div class="modal-actions">
                <button class="add-btn" id="addToFootprintBtn">添加到足迹</button>
                <button class="upload-btn" id="uploadPictureBtn">上传图片</button>
                <button class="close-btn" id="closeDetailModal">关闭</button>
            </div>
            <!-- 隐藏文件输入 -->
            <input type="file" id="imageUploadInput" accept="image/*" style="display:none;" />
        </div>
    </div>

    <!-- 引入 ECharts 和地图 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="map_with_china_districts.js"></script>

    <script>
        // ========== 全局数据 ==========
        let travelRecords = JSON.parse(localStorage.getItem('travelRecords') || '[]');
        let customAreaImages = JSON.parse(localStorage.getItem('customAreaImages') || '{}');
        let currentClickedArea = null;

        // ========== 初始化 ECharts ==========
        const myChart = echarts.init(document.getElementById('main'));

        // 提取所有区域名
        const allAreas = [];
        try {
            const mapData = echarts.getMap('world');
            if (mapData && mapData.geoJson?.features) {
                mapData.geoJson.features.forEach(f => {
                    if (f.properties?.name) {
                        allAreas.push(f.properties.name);
                    }
                });
            }
        } catch (e) {
            console.warn('无法加载区域列表');
        }

        function generateMapData() {
            return allAreas.map(name => {
                const record = travelRecords.find(r => r.name === name);
                return { name, value: record ? record.count : 0 };
            });
        }

        // ========== ECharts 配置（含悬浮图片预览）==========
        const option = {
            tooltip: {
                trigger: 'item',
                confine: true,
                extraCssText: `
                    max-width: 300px;
                    white-space: normal;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    border-radius: 8px;
                    padding: 0;
                    border: none;
                `,
                formatter: function(params) {
                    if (!params.name) return '';
                    
                    // 获取图片：优先用户上传，其次默认占位图
                    const imgUrl = customAreaImages[params.name] || 
                        'https://via.placeholder.com/200x130/e0e0e0/999999?text=暂无自定义图';
                    
                    return `
                        <div style="text-align:center; padding:8px; min-width:120px;">
                            <div style="font-weight:bold; margin-bottom:6px; font-size:14px;">${params.name}</div>
                            <img 
                                src="${imgUrl}" 
                                style="width:200px; max-width:100%; height:auto; border-radius:6px; display:block; margin:0 auto;"
                                onerror="this.onerror=null; this.src='https://via.placeholder.com/200x130/e0e0e0/999999?text=加载失败';"
                            >
                        </div>
                    `;
                }
            },
            visualMap: {
                show: false,
                min: 0,
                max: 10,
                inRange: {
                    color: ['#f0f0f0', '#5470c6']
                }
            },
            series: [{
                type: 'map',
                map: 'world',
                roam: true,
                zoom: 1.2,
                center: [105, 38],
                label: {
                    show: false,
                    emphasis: { show: true, color: '#333' }
                },
                itemStyle: {
                    areaColor: '#f0f0f0',
                    borderColor: '#ccc',
                    borderWidth: 0.5
                },
                emphasis: {
                    itemStyle: {
                        areaColor: '#e6f7ff',
                        borderColor: '#1890ff'
                    }
                },
                data: generateMapData()
            }]
        };

        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());

        // ========== 弹窗控制 ==========
        function openDetailModal(areaName) {
            currentClickedArea = areaName;
            document.getElementById('modalAreaName').textContent = areaName;
            const imgUrl = customAreaImages[areaName] || 
                'https://via.placeholder.com/600x400/e0e0e0/999999?text=点击“上传图片”自定义';
            document.getElementById('modalImage').src = imgUrl;
            document.getElementById('detailModal').style.display = 'flex';
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
            currentClickedArea = null;
        }

        // ========== 功能 ==========
        function addToFootprint(areaName) {
            const existing = travelRecords.find(r => r.name === areaName);
            if (existing) existing.count++;
            else travelRecords.push({ name: areaName, count: 1 });
            localStorage.setItem('travelRecords', JSON.stringify(travelRecords));
            myChart.setOption({ series: [{ data: generateMapData() }] });
            alert(`✅ 已将 ${areaName} 添加到足迹！`);
        }

        function uploadPictureForArea(areaName) {
            const input = document.getElementById('imageUploadInput');
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (!file.type.startsWith('image/')) {
                    alert('❌ 请选择图片文件（JPG/PNG/GIF）');
                    return;
                }
                if (file.size > 2 * 1024 * 1024) {
                    if (!confirm('图片超过 2MB，可能影响性能，是否继续？')) return;
                }
                const reader = new FileReader();
                reader.onload = () => {
                    customAreaImages[areaName] = reader.result;
                    localStorage.setItem('customAreaImages', JSON.stringify(customAreaImages));
                    document.getElementById('modalImage').src = reader.result;
                    alert(`✅ ${areaName} 的图片已保存！`);
                };
                reader.readAsDataURL(file);
                input.value = '';
            };
            input.click();
        }

        // ========== 事件绑定 ==========
        myChart.on('click', (params) => {
            if (params.name) openDetailModal(params.name);
        });

        document.getElementById('addToFootprintBtn').onclick = () => {
            if (currentClickedArea) {
                addToFootprint(currentClickedArea);
                closeDetailModal();
            }
        };

        document.getElementById('uploadPictureBtn').onclick = () => {
            if (currentClickedArea) {
                uploadPictureForArea(currentClickedArea);
            }
        };

        document.getElementById('closeDetailModal').onclick = closeDetailModal;

        document.getElementById('detailModal').onclick = (e) => {
            if (e.target === document.getElementById('detailModal')) {
                closeDetailModal();
            }
        };

        // ========== 控制面板 ==========
        document.getElementById('resetBtn').onclick = () => {
            if (confirm('⚠️ 确定重置所有足迹记录和自定义图片？此操作不可恢复！')) {
                travelRecords = [];
                customAreaImages = {};
                localStorage.removeItem('travelRecords');
                localStorage.removeItem('customAreaImages');
                myChart.setOption({ series: [{ data: generateMapData() }] });
                alert('✅ 已重置所有数据');
            }
        };

        document.getElementById('exportBtn').onclick = () => {
            const data = { travelRecords, customAreaImages };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my_travel_map_data.json';
            a.click();
            URL.revokeObjectURL(url);
        };

        document.getElementById('importBtn').onclick = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const data = JSON.parse(reader.result);
                        if (Array.isArray(data.travelRecords) && typeof data.customAreaImages === 'object' && data.customAreaImages !== null) {
                            travelRecords = data.travelRecords;
                            customAreaImages = data.customAreaImages;
                            localStorage.setItem('travelRecords', JSON.stringify(travelRecords));
                            localStorage.setItem('customAreaImages', JSON.stringify(customAreaImages));
                            myChart.setOption({ series: [{ data: generateMapData() }] });
                            alert('✅ 数据导入成功！');
                        } else {
                            throw new Error('格式错误');
                        }
                    } catch (err) {
                        alert('❌ 导入失败：请使用“导出数据”生成的文件。');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };
    </script>
</body>
</html>