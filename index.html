<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>我的旅行足迹地图</title>
  <style>
    body { margin: 0; background: #f4f4f4; font-family: "Microsoft YaHei"; }
    #map { width: 100%; height: 100vh; }

    .info-box {
      position: fixed;
      top: 10px; right: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 20;
    }
    .info-box button {
      display: block;
      width: 100%;
      margin-top: 6px;
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .tooltip-box {
      position: absolute;
      background: rgba(255,255,255,0.96);
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      display: none;
      pointer-events: auto;
      max-width: 260px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      z-index: 10;
      transition: opacity 0.25s ease;
    }
    .tooltip-box img {
      width: 100%;
      border-radius: 6px;
      margin-top: 6px;
    }
    .tooltip-box button {
      margin-top: 6px;
      padding: 4px 8px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .edit-modal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
      width: 320px;
      display: none;
      z-index: 100;
    }
    .edit-modal input, .edit-modal textarea {
      width: 100%;
      margin-bottom: 8px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .edit-modal button {
      margin-top: 5px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #save-btn { background: #28a745; color: white; }
    #cancel-btn { background: #aaa; color: white; margin-left: 10px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info-box">
    <button id="login-btn">进入编辑模式</button>
    <button id="logout-btn" style="display:none;">退出编辑模式</button>
    <button id="reset-btn" style="display:none;">重置所有记录</button>
    <button id="export-btn" style="display:none;">导出记录</button>
    <input type="file" id="import-file" style="display:none;">
    <button id="import-btn" style="display:none;">导入记录</button>
  </div>
  <div id="tooltip" class="tooltip-box"></div>

  <div id="edit-modal" class="edit-modal">
    <h3>编辑旅行记录</h3>
    <input type="text" id="edit-country" readonly>
    <textarea id="edit-desc" rows="3" placeholder="写下你的旅行感受..."></textarea>
    <input type="file" id="edit-image">
    <button id="save-btn">保存</button>
    <button id="cancel-btn">取消</button>
  </div>

  <script src="style.js"></script>
  <script src="map.js"></script>
  <script>
    const ADMIN_PASS = atob("MTIzNDU2");

    const myChart = echarts.init(document.getElementById('map'));
    const tooltip = document.getElementById('tooltip');
    const modal = document.getElementById('edit-modal');

    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const resetBtn = document.getElementById('reset-btn');
    const exportBtn = document.getElementById('export-btn');
    const importBtn = document.getElementById('import-btn');
    const importFile = document.getElementById('import-file');

    let travelInfo = JSON.parse(localStorage.getItem('travelInfo')) || {};
    let visited = JSON.parse(localStorage.getItem('visited')) || {};
    let fixedCountry = null;
    let editMode = localStorage.getItem('editMode') === 'true';

    function updateUI() {
      const show = editMode ? 'block' : 'none';
      loginBtn.style.display = editMode ? 'none' : 'block';
      logoutBtn.style.display = show;
      resetBtn.style.display = show;
      exportBtn.style.display = show;
      importBtn.style.display = show;
    }
    updateUI();

    function saveToLocal() {
      localStorage.setItem('travelInfo', JSON.stringify(travelInfo));
      localStorage.setItem('visited', JSON.stringify(visited));
    }

    function getRandomColor() {
      const letters = '89ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) color += letters[Math.floor(Math.random() * letters.length)];
      return color;
    }

    const option = {
      tooltip: { show: false },
      series: [{
        name: 'world',
        type: 'map',
        map: 'world',
        roam: true,
        zoom: 1.2,
        label: { show: false },
        itemStyle: {
          normal: { areaColor: '#f8f8f8', borderColor: '#aaa' },
          emphasis: { areaColor: '#e0e0e0' }
        },
        data: []
      }]
    };
    myChart.setOption(option);

    function updateMap() {
      myChart.setOption({
        series: [{
          data: Object.keys(visited).map(k => ({
            name: k,
            itemStyle: { areaColor: visited[k] }
          }))
        }]
      });
    }
    updateMap();

    // 单击：选中/取消
    myChart.on('click', function (params) {
      if (!editMode) return;
      const name = params.name;

      if (fixedCountry === name) {
        delete visited[name];
        saveToLocal();
        updateMap();
        tooltip.style.display = 'none';
        fixedCountry = null;
        return;
      }

      visited[name] = visited[name] || getRandomColor();
      updateMap();
      saveToLocal();
      showTooltip(name, params.event.offsetX, params.event.offsetY);
      fixedCountry = name;
    });

    // 双击：居中放大
    myChart.on('dblclick', function (params) {
      if (!editMode) return;
      myChart.dispatchAction({
        type: 'geoRoam',
        zoom: 1.8,
        originX: params.event.offsetX,
        originY: params.event.offsetY
      });
    });

    // 右键删除
    myChart.getZr().on('contextmenu', function (event) {
      if (!editMode) return;
      event.preventDefault();
      const pointInPixel = [event.offsetX, event.offsetY];
      if (myChart.containPixel({ seriesIndex: 0 }, pointInPixel)) {
        const geo = myChart.getModel().getSeriesByIndex(0).coordinateSystem;
        const coord = myChart.convertFromPixel({ seriesIndex: 0 }, pointInPixel);
        const region = geo.getRegionByCoord(coord);
        const name = region ? region.name : null;
        if (name && visited[name]) {
          if (confirm(`确定删除 ${name} 的旅行记录吗？`)) {
            delete visited[name];
            delete travelInfo[name];
            saveToLocal();
            updateMap();
            tooltip.style.display = 'none';
            fixedCountry = null;
          }
        }
      }
    });

    // 空白点击关闭弹窗
    myChart.getZr().on('click', function (event) {
      const pointInPixel = [event.offsetX, event.offsetY];
      if (!myChart.containPixel({ seriesIndex: 0 }, pointInPixel)) {
        tooltip.style.display = 'none';
        fixedCountry = null;
      }
    });

    // 悬浮提示
    myChart.on('mouseover', function (params) {
      if (!fixedCountry) showTooltip(params.name, params.event.offsetX, params.event.offsetY);
    });
    myChart.on('mouseout', function () {
      if (!fixedCountry) tooltip.style.display = 'none';
    });

    function showTooltip(name, x, y) {
      const info = travelInfo[name];
      const editButton = editMode
        ? `<button onclick="openEditor('${name}')">编辑</button>`
        : '';
      tooltip.innerHTML = `
        <strong>${name}</strong><br>
        <p>${info ? info.desc : (editMode ? '点击编辑旅行记录' : '等待探索')}</p>
        ${info && info.img ? `<img src="${info.img}" alt="${name}">` : ''}
        ${editButton}
      `;
      tooltip.style.left = x + 20 + 'px';
      tooltip.style.top = y + 20 + 'px';
      tooltip.style.opacity = 0;
      tooltip.style.display = 'block';
      setTimeout(() => tooltip.style.opacity = 1, 10);
    }

    window.openEditor = function (name) {
      const info = travelInfo[name] || { desc: '', img: '' };
      document.getElementById('edit-country').value = name;
      document.getElementById('edit-desc').value = info.desc;
      document.getElementById('edit-image').value = '';
      modal.style.display = 'block';
    };

    document.getElementById('save-btn').onclick = () => {
      const name = document.getElementById('edit-country').value;
      const desc = document.getElementById('edit-desc').value;
      const file = document.getElementById('edit-image').files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          travelInfo[name] = { desc, img: e.target.result };
          saveToLocal();
          modal.style.display = 'none';
          if (fixedCountry === name)
            showTooltip(name, parseInt(tooltip.style.left), parseInt(tooltip.style.top));
        };
        reader.readAsDataURL(file);
      } else {
        travelInfo[name] = { desc, img: travelInfo[name]?.img || '' };
        saveToLocal();
        modal.style.display = 'none';
        if (fixedCountry === name)
          showTooltip(name, parseInt(tooltip.style.left), parseInt(tooltip.style.top));
      }
    };
    document.getElementById('cancel-btn').onclick = () => modal.style.display = 'none';

    // 导出 JSON
    exportBtn.onclick = () => {
      const data = { visited, travelInfo };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '我的旅行足迹.json';
      a.click();
      URL.revokeObjectURL(url);
    };

    // 导入 JSON
    importBtn.onclick = () => importFile.click();
    importFile.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          visited = data.visited || {};
          travelInfo = data.travelInfo || {};
          saveToLocal();
          updateMap();
          alert("成功导入旅行数据！");
        } catch {
          alert("导入失败，请检查文件格式！");
        }
      };
      reader.readAsText(file);
    };

    // 重置
    resetBtn.onclick = () => {
      if (confirm("确定清空所有旅行记录？")) {
        localStorage.clear();
        travelInfo = {};
        visited = {};
        fixedCountry = null;
        updateMap();
        tooltip.style.display = 'none';
      }
    };

    // 登录 / 退出
    loginBtn.onclick = () => {
      const input = prompt("请输入管理员密码：");
      if (input === ADMIN_PASS) {
        editMode = true;
        localStorage.setItem('editMode', 'true');
        updateUI();
        alert("已进入编辑模式");
      } else if (input) alert("密码错误");
    };
    logoutBtn.onclick = () => {
      editMode = false;
      localStorage.setItem('editMode', 'false');
      updateUI();
      alert("已退出编辑模式");
    };
  </script>
</body>
</html>
